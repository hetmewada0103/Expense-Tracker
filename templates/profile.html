{% extends "base.html" %}

{% block title %}Profile - Expense Tracker{% endblock %}

{% block content %}
{% include 'nav_menu.html' %}

<div class="dashboard-wrapper">
    <!-- Hero Section -->
    <section class="hero-section py-4 mb-4">
        <div class="container">
            <div class="row align-items-center justify-content-center text-center">
                <div class="col-lg-8 col-md-10">
                    <h1 class="hero-title mb-3">
                        <i class="bi bi-person-circle me-2 text-white"></i>Profile
                    </h1>
                    <p class="hero-subtitle mb-0">Update your personal information and preferences</p>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <!-- Profile Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0 fw-semibold">
                        <i class="bi bi-person-lines-fill me-2 text-primary"></i>Account Details
                    </h3>
                </div>

                <!-- Profile Form Card -->
                <div class="card profile-card shadow-lg">
                    <div class="card-body p-4">
                        <form id="profileForm" novalidate>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Username *</label>
                                    <input type="text" class="form-control form-control-lg" id="username" 
                                           value="{{ user.username }}" required maxlength="50">
                                    <div class="invalid-feedback" id="username-error"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Email *</label>
                                    <input type="email" class="form-control form-control-lg" id="email" 
                                           value="{{ user.email }}" required>
                                    <div class="invalid-feedback" id="email-error"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Phone Number</label>
                                    <input type="tel" class="form-control form-control-lg" id="phone" 
                                           value="{{ user.phone or '' }}" placeholder="+91 98765 43210">
                                    <div class="invalid-feedback" id="phone-error"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Currency *</label>
                                    <select class="form-select form-select-lg" id="currency" required>
                                        <option value="USD" {% if user.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                                        <option value="EUR" {% if user.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                                        <option value="GBP" {% if user.currency == 'GBP' %}selected{% endif %}>GBP (£)</option>
                                        <option value="INR" {% if user.currency == 'INR' %}selected{% endif %}>INR (₹)</option>
                                        <option value="JPY" {% if user.currency == 'JPY' %}selected{% endif %}>JPY (¥)</option>
                                    </select>
                                    <div class="invalid-feedback" id="currency-error"></div>
                                </div>
                            </div>
                            
                            <!-- ✅ FIXED BUTTON ALIGNMENT -->
                            <div class="d-flex justify-content-center gap-3 mt-5 p-0">
                                <button type="submit" class="btn btn-primary btn-medium px-5 py-2 fw-semibold flex-fill">
                                    Update Profile
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-medium px-5 py-2 fw-semibold clean-reset-btn flex-fill" 
                                        id="resetBtn">
                                    Reset
                                </button>
                            </div>
                        </form>
                        
                        <div id="profileMessage" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
:root {
    --blue-primary: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    --primary-blue: #2563eb;
    --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    --border-radius: 16px;
}

.dashboard-wrapper {
    padding-top: 75px;
    /* ✅ CHANGED TO STATISTICS BACKGROUND */
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    min-height: 100vh;
}

.hero-section {
    background: var(--blue-primary);
    color: white;
    margin-bottom: 0;
}

.hero-title {
    font-size: 2.2rem;
    font-weight: 800;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.hero-subtitle {
    font-size: 1.1rem;
    opacity: 0.95;
}

.profile-card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    background: white;
    overflow: hidden;
}

.profile-card .form-control-lg,
.profile-card .form-select-lg {
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 0.875rem 1.25rem;
    font-weight: 500;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.profile-card .form-control-lg:focus,
.profile-card .form-select-lg:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.15);
    transform: translateY(-1px);
}

.btn-medium {
    padding: 0.625rem 2rem !important;
    font-size: 0.95rem !important;
    border-radius: 12px;
    font-weight: 600;
    min-height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.flex-fill {
    flex: 1;
    max-width: 200px;
}

.btn-primary {
    background: var(--primary-blue);
    border: none;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
}

.btn-outline-secondary:hover {
    transform: translateY(-1px);
}

/* ✅ PERFECT BUTTON ALIGNMENT & NO GREEN BORDERS */
.clean-reset-btn {
    border: 1px solid #6c757d !important;
    outline: none !important;
    box-shadow: none !important;
}

.clean-reset-btn:hover,
.clean-reset-btn:focus,
.clean-reset-btn:active,
.clean-reset-btn:focus-visible,
.clean-reset-btn:focus-within {
    border-color: #5a6268 !important;
    outline: none !important;
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25) !important;
    background-color: #f8f9fa;
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.invalid-feedback {
    display: none;
    font-size: 0.8rem;
    color: #dc3545;
    margin-top: 0.25rem;
}

.invalid-feedback.show {
    display: block;
}

#profileMessage.alert-success {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 0.375rem;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
}

#profileMessage.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 0.375rem;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
}

/* Responsive */
@media (max-width: 768px) {
    .hero-title { font-size: 1.9rem; }
    .hero-subtitle { font-size: 1rem; }
    .flex-fill { max-width: none; }
    .gap-3 { gap: 1rem !important; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function resetForm() {
    document.getElementById('username').value = "{{ user.username }}";
    document.getElementById('email').value = "{{ user.email }}";
    document.getElementById('phone').value = "{{ user.phone or '' }}";
    document.getElementById('currency').value = "{{ user.currency }}";
    
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-invalid', 'is-valid');
        field.style.borderColor = '#e2e8f0';
        field.style.boxShadow = 'none';
    });
    
    document.querySelectorAll('.invalid-feedback').forEach(error => {
        error.classList.remove('show');
        error.textContent = '';
    });
    
    document.getElementById('profileMessage').innerHTML = '';
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const resetBtn = document.getElementById('resetBtn');
    
    form.addEventListener('input', function(e) {
        const field = e.target;
        const errorDiv = document.getElementById(field.id + '-error');
        
        field.classList.remove('is-invalid');
        errorDiv.classList.remove('show');
        
        switch(field.id) {
            case 'username':
                if (field.value.trim().length < 3 || field.value.trim().length > 50) {
                    field.classList.add('is-invalid');
                    errorDiv.textContent = 'Username must be 3-50 characters';
                    errorDiv.classList.add('show');
                }
                break;
            case 'email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(field.value)) {
                    field.classList.add('is-invalid');
                    errorDiv.textContent = 'Please enter a valid email';
                    errorDiv.classList.add('show');
                }
                break;
            case 'phone':
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                if (field.value && !phoneRegex.test(field.value.replace(/\D/g, ''))) {
                    field.classList.add('is-invalid');
                    errorDiv.textContent = 'Please enter a valid phone number';
                    errorDiv.classList.add('show');
                }
                break;
        }
    });
    
    resetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        resetForm();
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let isValid = true;
        const fields = ['username', 'email', 'currency'];
        
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');
            
            field.classList.remove('is-invalid');
            errorDiv.classList.remove('show');
            
            switch(fieldId) {
                case 'username':
                    if (field.value.trim().length < 3 || field.value.trim().length > 50) {
                        field.classList.add('is-invalid');
                        errorDiv.textContent = 'Username must be 3-50 characters';
                        errorDiv.classList.add('show');
                        isValid = false;
                    }
                    break;
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(field.value)) {
                        field.classList.add('is-invalid');
                        errorDiv.textContent = 'Please enter a valid email';
                        errorDiv.classList.add('show');
                        isValid = false;
                    }
                    break;
            }
        });
        
        if (!isValid) return;
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Saving...';
        
        const data = {
            username: document.getElementById('username').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            currency: document.getElementById('currency').value
        };
        
        try {
            const response = await fetch('/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            const messageDiv = document.getElementById('profileMessage');
            
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.innerHTML = 'Profile updated successfully';
            
            if (result.success === false) {
                messageDiv.className = 'alert alert-danger mt-3';
                messageDiv.innerHTML = result.message || 'Failed to update profile';
            }
            
        } catch (error) {
            const messageDiv = document.getElementById('profileMessage');
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.innerHTML = 'Profile updated successfully';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
});
</script>
{% endblock %}
