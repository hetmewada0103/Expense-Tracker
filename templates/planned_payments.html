{% extends "base.html" %}

{% block title %}Planned Payments - Expense Tracker{% endblock %}

{% block content %}
{% include 'nav_menu.html' %}

<div class="dashboard-wrapper">
    <section class="hero-section py-4 mb-4">
        <div class="container">
            <div class="row align-items-center justify-content-center text-center">
                <div class="col-lg-8 col-md-10">
                    <h1 class="hero-title mb-3">Planned Payments</h1>
                    <p class="hero-subtitle mb-0">Manage recurring payments, subscriptions, EMIs, rent & upcoming bills</p>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0 fw-semibold">
                        <i class="bi bi-clock-history me-2 text-primary"></i>Upcoming Payments
                    </h3>
                    <button class="btn btn-primary btn-medium px-4 py-2 fw-semibold" 
                            data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                        <i class="bi bi-plus-circle me-2"></i>Add New Payment
                    </button>
                </div>

                <div class="card payments-card-compact shadow-lg">
                    <div class="card-body p-3">
                        {% if payments %}
                            <div class="table-responsive">
                                <table class="table table-hover compact-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Title</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Category</th>
                                            <th>Recurring</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in payments %}
                                        <tr class="payment-row">
                                            <td class="fw-semibold">{{ payment.title[:20] }}{% if payment.title|length > 20 %}...{% endif %}</td>
                                            <td class="text-success fw-bold">₹{{ "%.2f"|format(payment.amount) }}</td>

                                            <td class="fw-bold">
                                                {% set today = now.strftime('%Y-%m-%d') %}
                                                {% if payment.payment_date < today %}
                                                    <span class="text-danger">Overdue</span>
                                                {% elif payment.payment_date == today %}
                                                    <span class="text-warning">Today</span>
                                                {% else %}
                                                    <span class="text-muted">Upcoming</span>
                                                {% endif %}
                                            </td>

                                            <td class="fw-bold text-secondary">
                                                {{ payment.category or 'General' }}
                                            </td>

                                            <td class="fw-semibold">
                                                {% if payment.recurring == 1 %}
                                                    <span class="text-muted">Yes</span>
                                                {% else %}
                                                    <span class="text-muted">No</span>
                                                {% endif %}
                                            </td>

                                                <td>
                                                    <div class="d-flex gap-2">
                                                        <button class="btn btn-edit-text btn-sm edit-btn"
                                                                data-id="{{ payment.id }}"
                                                                data-title="{{ payment.title|e }}"
                                                                data-amount="{{ payment.amount }}"
                                                                data-date="{{ payment.payment_date }}"
                                                                data-category="{{ payment.category or '' }}"
                                                                data-recurring="{{ '1' if payment.recurring else '0' }}">
                                                            Edit
                                                        </button>

                                                        <button class="btn btn-delete-text btn-sm delete-btn"
                                                                data-id="{{ payment.id }}">
                                                            Delete
                                                        </button>
                                                    </div>

                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="empty-state-compact text-center py-4">
                                <div class="empty-icon mb-3">
                                    <i class="bi bi-calendar-x fs-1 text-muted"></i>
                                </div>
                                <h5 class="text-muted mb-2">No planned payments</h5>
                                <p class="text-muted small mb-3">Add rent, EMI, or subscriptions to get started</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-2">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-calendar-plus text-primary me-2"></i>Add Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="paymentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Amount *</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-primary text-white small">₹</span>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Due Date *</label>
                            <input type="date" class="form-control" id="payment_date" name="payment_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">Choose...</option>
                                <option value="Rent">Rent</option>
                                <option value="EMI">EMI/Loan</option>
                                <option value="Subscription">Subscription</option>
                                <option value="Utility">Utility</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch form-switch-sm">
                                <input class="form-check-input" type="checkbox" id="recurring" name="recurring">
                                <label class="form-check-label fw-semibold small" for="recurring">Recurring Payment</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-1">
                <button type="button" class="btn btn-outline-secondary btn-sm px-4 py-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm px-4 py-2" id="submitPayment">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-2">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-pencil text-primary me-2"></i>Edit Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="editPaymentForm">
                    <input type="hidden" id="edit_payment_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Title *</label>
                            <input type="text" class="form-control" id="edit_title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Amount *</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-primary text-white small">₹</span>
                                <input type="number" class="form-control" id="edit_amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Due Date *</label>
                            <input type="date" class="form-control" id="edit_payment_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Category</label>
                            <select class="form-select" id="edit_category">
                                <option value="">Choose...</option>
                                <option value="Rent">Rent</option>
                                <option value="EMI">EMI/Loan</option>
                                <option value="Subscription">Subscription</option>
                                <option value="Utility">Utility</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch form-switch-sm">
                                <input class="form-check-input" type="checkbox" id="edit_recurring">
                                <label class="form-check-label fw-semibold small" for="edit_recurring">Recurring Payment</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-1">
                <button type="button" class="btn btn-outline-secondary btn-sm px-4 py-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm px-4 py-2" id="submitEditPayment">Update</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>

    .btn-edit-text {
    background: transparent;
    color: #2563eb;
    border: 2px solid #2563eb;
    font-weight: 600;
    padding: 4px 16px;
    border-radius: 10px;
    min-width: 64px;
    text-align: center;
}

.btn-edit-text:hover {
    background: #2563eb;
    color: #ffffff;
}

.btn-delete-text {
    background: transparent;
    color: #dc2626;
    border: 2px solid #dc2626;
    font-weight: 600;
    padding: 4px 16px;
    border-radius: 10px;
    min-width: 72px;
    text-align: center;
}

.btn-delete-text:hover {
    background: #dc2626;
    color: #ffffff;
}

:root {
    --blue-primary: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    --primary-blue: #2563eb;
    --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    --border-radius: 16px;
}
.dashboard-wrapper { padding-top: 75px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); min-height: 100vh; }
.hero-section { background: var(--blue-primary); color: white; margin-bottom: 0; }
.hero-title { font-size: 2.2rem; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.hero-subtitle { font-size: 1.1rem; opacity: 0.95; }
.payments-card-compact { border: none; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); overflow: hidden; background: white; }
.compact-table { margin-bottom: 0; font-size: 0.9rem; }
.compact-table th { font-weight: 600; color: #1f2937; border: none; padding: 0.875rem 0.75rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
.compact-table td { padding: 0.875rem 0.75rem; vertical-align: middle; border-color: #f1f5f9; }
.badge-sm, .badge-xs { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
.empty-state-compact { padding: 2rem 1.5rem; }
.empty-icon i { opacity: 0.3; }
.btn-medium { padding: 0.5rem 1.5rem !important; font-size: 0.95rem !important; border-radius: 10px; font-weight: 600; }
.btn-primary { background: var(--primary-blue); border: none; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
.btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); }
.btn-group-sm .btn { border-radius: 6px !important; font-size: 0.8rem; height: 32px; width: 36px; display: flex; align-items: center; justify-content: center; }
.btn-group-sm .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
.modal-content { border-radius: var(--border-radius); }
.form-control, .form-select { border-radius: 10px; border: 2px solid #e2e8f0; padding: 0.625rem 1rem; font-weight: 500; font-size: 0.9rem; }
.form-control:focus, .form-select:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.15); }
.input-group-sm .input-group-text { background: var(--primary-blue) !important; color: white; border: none !important; font-weight: 600; font-size: 0.85rem; }
.form-switch-sm .form-check-input { width: 2.5em; height: 1.25em; }
.form-switch-sm .form-check-input:checked { background-color: var(--primary-blue); border-color: var(--primary-blue); }
@media (max-width: 768px) { .hero-title { font-size: 1.9rem; } .btn-group-sm .btn { width: 32px; height: 30px; font-size: 0.75rem; } }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add Payment
    document.getElementById('submitPayment').addEventListener('click', async function() {
        const formData = {
            title: document.getElementById('title').value.trim(),
            amount: parseFloat(document.getElementById('amount').value),
            payment_date: document.getElementById('payment_date').value,
            category: document.getElementById('category').value || null,
            recurring: document.getElementById('recurring').checked ? 1 : 0
        };
        
        if (!formData.title || !formData.amount || !formData.payment_date) {
            alert('Please fill all required fields');
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Saving...';
        
        try {
            const response = await fetch('/planned_payments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            
            if (result.success) {
                btn.innerHTML = 'Saved! ✅';
                setTimeout(() => location.reload(), 1200);
            } else {
                alert(result.message || 'Error saving payment');
            }
        } catch (error) {
            alert('Network error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Edit Payment
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('edit_payment_id').value = this.dataset.id;
            document.getElementById('edit_title').value = this.dataset.title;
            document.getElementById('edit_amount').value = this.dataset.amount;
            document.getElementById('edit_payment_date').value = this.dataset.date;
            document.getElementById('edit_category').value = this.dataset.category;
            document.getElementById('edit_recurring').checked = this.dataset.recurring == '1';
            new bootstrap.Modal(document.getElementById('editPaymentModal')).show();
        });
    });

    document.getElementById('submitEditPayment').addEventListener('click', async function() {
        const formData = {
            id: document.getElementById('edit_payment_id').value,
            title: document.getElementById('edit_title').value.trim(),
            amount: parseFloat(document.getElementById('edit_amount').value),
            payment_date: document.getElementById('edit_payment_date').value,
            category: document.getElementById('edit_category').value || null,
            recurring: document.getElementById('edit_recurring').checked ? 1 : 0
        };
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Updating...';
        
        try {
            const response = await fetch(`/edit_planned_payment/${formData.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            
            if (result.success) {
                btn.innerHTML = 'Updated! ✅';
                setTimeout(() => location.reload(), 1200);
            } else {
                alert(result.message || 'Error updating payment');
            }
        } catch (error) {
            alert('Network error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Delete Payment
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to delete this payment?')) {
                try {
                    const response = await fetch(`/delete_planned_payment/${this.dataset.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Delete failed');
                    }
                } catch (error) {
                    alert('Network error');
                }
            }
        });
    });

    // Set default date
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('payment_date').value = tomorrow.toISOString().split('T')[0];
});
</script>
{% endblock %}
